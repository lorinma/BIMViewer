<!DOCTYPE html>
<html>
<head>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
<script type="text/javascript" src="three.min.js"></script>
<!--<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r71/three.js"></script>-->
<script type="text/javascript" src="TrackballControls.js"></script>
<style>
body {
    background-color: white;
}
</style>
<script>
$.urlParam = function(name){
    var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
    if (results==null){
       return null;
    }
    else{
       return results[1] || 0;
    }
}
$(document).ready(function() {
    var url = $.urlParam('url')
    url = (url==null||url==0)?"DamagedBeam.pcd":url;
    var r = $.urlParam('r')
    r = (r==null)?0.0:parseFloat(r);
    var g = $.urlParam('g')
    g = (g==null)?0.0:parseFloat(g);
    var b = $.urlParam('b')
    b = (b==null)?0.0:parseFloat(b);
    var size = $.urlParam('size')
    size = (size==null||size==0)?0.01:parseFloat(size);
    // 'use strict';
    // 'To actually be able to display anything with Three.js, we need three things:
    // A scene, a camera, and a renderer so we can render the scene with the camera.'
    // - http://threejs.org/docs/#Manual/Introduction/Creating_a_scene
    // var url = "5588bca7192d2a000a0c02e1.pcd";
    // var url = "https://preview.c9users.io/lorinma/python/5588bca7192d2a000a0c02e1.pcd"
    var color = [r,g,b];
    
    var scene, camera, renderer;
    var geometry, controls, container, cross;
			
    var HEIGHT, WIDTH, windowHalfX, windowHalfY, fieldOfView, 
        aspectRatio, nearPlane, farPlane, cameraZ, fogHex, fogDensity,
        container, material, points, mouseX = 0, mouseY = 0;
    
    $.get(url, function(data, status){
        var lines = data.split('\n');
        
        geometry = new THREE.Geometry(); /* NO ONE SAID ANYTHING ABOUT MATH! UGH!   */
        $.each(lines, function(index, value) {
            //only when the content line has number
            if (!isNaN(parseFloat(value))){
                var point_cor=value.split(' ');
                if(point_cor.length<3){
                    return false;
                }
                var z=-parseFloat(point_cor[0]);
                var x=-parseFloat(point_cor[1]);
                var y=parseFloat(point_cor[2]);
                var vertex = new THREE.Vector3();
                vertex.x = x;
                vertex.y = y;
                vertex.z = z;
                geometry.vertices.push(vertex);
            }
        });
        geometry.center();
        init();
        animate();
    });
        
    function init() {
        HEIGHT = window.innerHeight;
        WIDTH = window.innerWidth;
        windowHalfX = WIDTH / 2;
        windowHalfY = HEIGHT / 2;
    
        fieldOfView = 25;
        aspectRatio = WIDTH / HEIGHT;
        nearPlane = 1;
        farPlane = 20;
    
        /*  fieldOfView — Camera frustum vertical field of view.
        aspectRatio — Camera frustum aspect ratio.
        nearPlane — Camera frustum near plane.
        farPlane — Camera frustum far plane.
    
        - http://threejs.org/docs/#Reference/Cameras/PerspectiveCamera
    
        In geometry, a frustum (plural: frusta or frustums)
        is the portion of a solid (normally a cone or pyramid)
        that lies between two parallel planes cutting it. - wikipedia.      */
    
        cameraZ = farPlane / 3; /*  So, 1000? Yes! move on! */
        fogHex = 0xFFFFFF; /* As black as your heart.   */
        fogDensity = 0.0007; /* So not terribly dense?  */
    
        camera = new THREE.PerspectiveCamera(fieldOfView, aspectRatio, nearPlane, farPlane);
        camera.position.z = cameraZ;
    
        scene = new THREE.Scene();
        scene.fog = new THREE.FogExp2(fogHex, fogDensity);
    
        container = document.createElement('div');
        document.body.appendChild(container);
        document.body.style.margin = 0;
        document.body.style.overflow = 'hidden';
        
        material = new THREE.PointCloudMaterial({size: size});
        points = new THREE.PointCloud(geometry, material);
        scene.add(points);
        
        renderer = new THREE.WebGLRenderer({ alpha: true }); /*    Rendererererers particles.  */
        renderer.setPixelRatio(window.devicePixelRatio); /* Probably 1; unless you're fancy.    */
        renderer.setSize(WIDTH, HEIGHT); /* Full screen baby Wooooo!    */
        renderer.setClearColor(0xFFFFFF);
        renderer.autoClear=true;
    
        container.appendChild(renderer.domElement); /* Let's add all this crazy junk to the page.   */
        /* Event Listeners */
        
		controls = new THREE.TrackballControls( camera );
		controls.rotateSpeed = 1.0;
		controls.zoomSpeed = 1.2;
		controls.panSpeed = 0.8;
		controls.noZoom = false;
		controls.noPan = false;
		controls.staticMoving = true;
		controls.dynamicDampingFactor = 0.3;
		controls.keys = [ 65, 83, 68 ];
		controls.addEventListener( 'change', render );
    }
    function animate() {
		requestAnimationFrame( animate );
		controls.update();
	}
    function render() {
        material.color = new THREE.Color(color[0],color[1],color[2]);
        camera.lookAt(scene.position);
		renderer.render( scene, camera );
	}
    function onWindowResize() {
        windowHalfX = window.innerWidth / 2;
        windowHalfY = window.innerHeight / 2;
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
		controls.handleResize();
		render();
    }
    
});
</script>
</head>
<body>

<div id="data"></div>
<div id="container"></div>
</body>
</html>